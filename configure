#!/bin/bash
# Configure script

# This is the maximum length of text (ignoring whitespace), 50 chars
##################################################
# this is the maximum amount of characters (including whitespace) per line)
######################################################################


            ##################################################
echo "INFO: This is the './configure' script.  You should only"
echo "INFO: run this once. The purpose of me is to:"
echo "INFO:"
echo "INFO:     1. Check that you have a compiler"
echo "INFO:     2. Check that you have Python"
echo "INFO:     3. Check your version of Python is supported"
echo "INFO:     4. Create files called 'env.sh' and 'env.csh'"
echo "INFO:        that store your environmental variables"
echo "INFO:"
echo

# Check for g++ ##################################################
(type -P gcc &>/dev/null && type -P g++ &>/dev/null) || {
    echo "FATAL: gcc/g++ is required to compile code." >&2;
    echo "FATAL:" >&2;
    echo "FATAL: To install within MAUS, set the MAUS_ROOT_DIR" >&2;
    echo "FATAL: environmental variable.  For Bourne-compatible" >&2;
    echo "FATAL: shells like 'bash', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      export MAUS_ROOT_DIR=\"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: whilst for C-compatible shells like 'csh', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      setenv MAUS_ROOT_DIR \"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: then run the following two commands to install" >&2;
    echo "FATAL: the GCC compiler and it's dependency MPFR:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      ./third_party/bash/01mpfr.bash" >&2;
    echo "FATAL:      ./third_party/bash/02gcc.bash" >&2;
    exit 1; }

# Find where MAUS is installed
maus_root_dir=`pwd`

if echo $maus_root_dir | grep -E '[ "]' >/dev/null;
then
    echo "FATAL: No whitespace allowed in directory names.">&2;
    echo "FATAL:">&2;
    echo "FATAL: See:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: http://micewww.pp.rl.ac.uk:8080/issues/306" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      export MAUS_ROOT_DIR=\"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: whilst for C-compatible shells like 'csh', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      setenv MAUS_ROOT_DIR \"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: then run the following to install Python 2.7:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      ./third_party/bash/03python.bash" >&2;
    exit 1;
fi

# Temporarily setup the environment (this gets repeated in the env.sh output)
#      PATH says where the binaries are
#      LD_LIBRARY_PATH says where your shared libraries are
if [ -z "${PATH}" ]; then  # see if the variable exists yet
    PATH="${maus_root_dir}/third_party/install/bin"       # if not, initialize it
else
    PATH="${maus_root_dir}/third_party/install/bin:$PATH" # else add to it
fi
if [ -z "${LD_LIBRARY_PATH}" ]; then  # see if the variable exists yet
    LD_LIBRARY_PATH="${maus_root_dir}/third_party/install/lib"                  # if not, initialize it
else
    LD_LIBRARY_PATH="${maus_root_dir}/third_party/install/lib:$LD_LIBRARY_PATH" # else add to to it
fi

# Check for Python
type -P python &>/dev/null || {
    echo "FATAL: Python is required.">&2;
    echo "FATAL:">&2;
    echo "FATAL: To install within MAUS, set the MAUS_ROOT_DIR" >&2;
    echo "FATAL: environmental variable.  For Bourne-compatible" >&2;
    echo "FATAL: shells like 'bash', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      export MAUS_ROOT_DIR=\"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: whilst for C-compatible shells like 'csh', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      setenv MAUS_ROOT_DIR \"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: then run the following to install Python 2.7:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      ./third_party/bash/03python.bash" >&2;
    exit 1; }

python_version=`LD_LIBRARY_PATH=./third_party/install/lib python -V 2>&1`
## Check for supported python version
if [ "${python_version}" != "Python 2.7" ]
then               ##################################################
    echo "WARNING: Unsupported python version (You are using ${python_version}),";
    echo "WARNING: so using Python 2.7 is recommended";
    echo "WARNING: ";
    echo "WARNING: To install within MAUS, set the MAUS_ROOT_DIR";
    echo "WARNING: environmental variable.  For Bourne-compatible";
    echo "WARNING: shells like 'bash', run:";
    echo "WARNING: ";
    echo "WARNING:       export MAUS_ROOT_DIR=\"${maus_root_dir}\"";
    echo "WARNING: ";
    echo "WARNING:  whilst for C-compatible shells like 'csh', run:";
    echo "WARNING: ";
    echo "WARNING:       setenv MAUS_ROOT_DIR \"${maus_root_dir}\"";
    echo "WARNING: ";
    echo "WARNING: then run the following to install Python 2.7:"
    echo "WARNING: ";
    echo "WARNING:       ./third_party/bash/03python.bash";
    echo
fi

# check for SCons
type -P scons &>/dev/null || {
    echo "FATAL: Scons is required. It's weird that it's not" >&2;
    echo "FATAL: since it ships within MAUS.  Is your MAUS ROOT" >&2;
    echo "FATAL: directory correct?." >&2;
    echo "FATAL:" >&2;
    echo "FATAL: To reinstall within MAUS, set the MAUS_ROOT_DIR" >&2;
    echo "FATAL: environmental variable.  For Bourne-compatible" >&2;
    echo "FATAL: shells like 'bash', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      export MAUS_ROOT_DIR=\"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: whilst for C-compatible shells like 'csh', run:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      setenv MAUS_ROOT_DIR \"${maus_root_dir}\"" >&2;
    echo "FATAL:" >&2;
    echo "FATAL: then run the following to install Scons:" >&2;
    echo "FATAL:" >&2;
    echo "FATAL:      ./third_party/bash/01scons.bash";
    echo "FATAL:";
    exit 1;}

root_version=root_v5.28.00a

### Create environment files

cat > env.sh <<EOF
#/bin/sh

if [ -f \${MAUS_ROOT_DIR}/third_party/build/$root_version/bin/thisroot.sh ]                                                                                                     
then                                                                                                                                                                            
     source \${MAUS_ROOT_DIR}/third_party/build/$root_version/bin/thisroot.sh                                                                                                   
fi    

if [ -z "\$MAUS_ROOT_DIR" ]; then
     export MAUS_ROOT_DIR="${maus_root_dir}"

     if [ -z "\${PATH}" ]; then  # see if the variable exists yet
         export PATH="\${MAUS_ROOT_DIR}/third_party/install/bin" # initialize it
     else
         export PATH="\${MAUS_ROOT_DIR}/third_party/install/bin:\${PATH}" # else add it
     fi

     if [ -z "\${LD_LIBRARY_PATH}" ]; then  # see if the variable exists yet
          export LD_LIBRARY_PATH="\${MAUS_ROOT_DIR}/third_party/install/lib" # intiailize it
     else
          export LD_LIBRARY_PATH="\${MAUS_ROOT_DIR}/third_party/install/lib:\${LD_LIBRARY_PATH}" # else add it
     fi

     export PATH="\${ROOTSYS}/bin:\${PATH}"
     export LD_LIBRARY_PATH="\${ROOTSYS}/lib:\${LD_LIBRARY_PATH}"
     if [ -z "\${PYTHONPATH}" ]; then  # see if the variable exists yet
          export PYTHONPATH="\${ROOTSYS}/lib" # intiailize it
     else
          export PYTHONPATH="\${ROOTSYS}/lib:\${PYTHONPATH}" # else add it
     fi

     # maus workers
     export PYTHONPATH="\$MAUS_ROOT_DIR/build:\$PYTHONPATH"
     export LD_LIBRARY_PATH="\$MAUS_ROOT_DIR/build:\$LD_LIBRARY_PATH"

     # maus core
     export PYTHONPATH="\$MAUS_ROOT_DIR/src/core:\$PYTHONPATH"
     export LD_LIBRARY_PATH="\$MAUS_ROOT_DIR/src/core:\$LD_LIBRARY_PATH"

     export G4DEBUG=1
     export G4VERS=geant4.9.2.p04
     export G4SYSTEM=Linux-g++
     export G4INSTALL="\${MAUS_ROOT_DIR}/third_party/build/\${G4VERS}"
     export G4LIB="\${G4INSTALL}/lib"
     export LD_LIBRARY_PATH="\${G4LIB}/\${G4SYSTEM}:\${LD_LIBRARY_PATH}"
     export G4INCLUDE="\${G4INSTALL}/include/"
     export G4TMP="\${G4INSTALL}"
     export G4VIS_BUILD_DAWNFILE_DRIVER=1
     export G4VIS_USE_DAWNFILE=1
     export G4VIS_USE=0
     export G4OPTIMISE=2
     export OGLHOME=/usr/X11R6
     export G4LEDATA="\${G4INSTALL}/data/G4EMLOW6.2/"
     export G4ABLADATA="\${G4INSTALL}/data/G4ABLA3.0/"
     export G4NEUTRONDATA="\${G4INSTALL}/data/G4NDL3.13/"
     export G4LEVELGAMMADATA"=\${G4INSTALL}/data/PhotonEvaporation2.0/"
     export G4RADIOACTIVEDATA"=\${G4INSTALL}/data/RadioactiveDecay3.2/"

     export MICEFILES="\${MAUS_ROOT_DIR}/src/common/FILES"

     echo "SUCCESS: MAUS setup"
else
     echo "WARNING: MAUS already setup"
fi

EOF

cat > env.csh <<EOF
#/bin/csh

if ({\$?MAUS_ROOT_DIR}) then
     echo "WARNING: MAUS already setup - rerunning script"
endif

setenv MAUS_ROOT_DIR "${maus_root_dir}"

if( ! -e \${MAUS_ROOT_DIR}/third_party/build/$root_version/bin/thisroot.csh ) then                                                                                              
    source \${MAUS_ROOT_DIR}/third_party/build/$root_version/bin/thisroot.csh                                                                                                  
endif   

if ({\$?PATH}) then
    setenv PATH "\${MAUS_ROOT_DIR}/third_party/install/bin:\${PATH}" # else add it
else
    setenv PATH "\${MAUS_ROOT_DIR}/third_party/install/bin" # initialize it
endif

if ({\$?LD_LIBRARY_PATH}) then
    setenv LD_LIBRARY_PATH "\${MAUS_ROOT_DIR}/third_party/install/lib:\${LD_LIBRARY_PATH}" # else add it
else
    setenv LD_LIBRARY_PATH "\${MAUS_ROOT_DIR}/third_party/install/lib" # intiailize it
endif

# ROOT specific garbage
if ({\$?ROOTSYS}) then
    setenv PATH "\${ROOTSYS}/bin:\${PATH}"
    setenv LD_LIBRARY_PATH "\${ROOTSYS}/lib:\${LD_LIBRARY_PATH}"
    if ({\$?PYTHONPATH}) then
         setenv PYTHONPATH "\${ROOTSYS}/lib:\${PYTHONPATH}" # else add it
    else
         setenv PYTHONPATH "\${ROOTSYS}/lib" # intiailize it
    endif
endif


# maus workers
setenv LD_LIBRARY_PATH "\$MAUS_ROOT_DIR/build:\$LD_LIBRARY_PATH"

# maus core
if ({\$?PYTHONPATH}) then
    setenv PYTHONPATH "\$MAUS_ROOT_DIR/src/core:\$PYTHONPATH"
else
    setenv PYTHONPATH "\$MAUS_ROOT_DIR/src/core" # intiailize it
endif

setenv LD_LIBRARY_PATH "\$MAUS_ROOT_DIR/src/core:\$LD_LIBRARY_PATH"

setenv G4DEBUG 1
setenv G4VERS geant4.9.2.p04
setenv G4SYSTEM Linux-g++
setenv G4INSTALL "\${MAUS_ROOT_DIR}/third_party/build/\${G4VERS}"
setenv G4LIB "\${G4INSTALL}/lib"
setenv LD_LIBRARY_PATH "\${G4LIB}/\${G4SYSTEM}:\${LD_LIBRARY_PATH}"
setenv G4INCLUDE "\${G4INSTALL}/include/"
setenv G4TMP "\${G4INSTALL}"
setenv G4VIS_BUILD_DAWNFILE_DRIVER 1
setenv G4VIS_USE_DAWNFILE 1
setenv G4VIS_USE 0
setenv G4OPTIMISE 2
setenv OGLHOME /usr/X11R6
setenv G4LEDATA "\${G4INSTALL}/data/G4EMLOW6.2/"
setenv G4ABLADATA "\${G4INSTALL}/data/G4ABLA3.0/"
setenv G4NEUTRONDATA "\${G4INSTALL}/data/G4NDL3.13/"
setenv G4LEVELGAMMADATA "\${G4INSTALL}/data/PhotonEvaporation2.0/"
setenv G4RADIOACTIVEDATA "\${G4INSTALL}/data/RadioactiveDecay3.2/"

setenv MICEFILES "\${MAUS_ROOT_DIR}/src/common/FILES"

echo "SUCCESS: MAUS setup"

EOF

echo "SUCCESS: Whenever you want to use MAUS, you must 'source'"
echo "SUCCESS: the environmental variables file.  For Bourne-"
echo "SUCCESS: compatible shells like 'bash', run:"
echo "SUCCESS:"
echo "SUCCESS:      source env.sh"
echo "SUCCESS:"
echo "SUCCESS: and for C-compatible shells, run:"
echo "SUCCESS:"
echo "SUCCESS:      source env.csh"
echo "SUCCESS:"
echo "SUCCESS: which can be added to your respective shell's"
echo "SUCCESS: startup scripts.  Example: ~/.bashrc for 'bash'."
