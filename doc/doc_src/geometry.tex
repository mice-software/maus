\chapter{Geometry}
\label{chapter:geometry}
MAUS uses the on-line Configuration Database to store all of its
geometries. These geometries have been transferred from CAD drawings
which are based on the latest surveys and technical drawings
available. The CAD drawings are translated to a geometry specific
subset of XML, the Geometry Description Markup Language (GDML) prior
to being recorded in the configuration database. Translation of the CAD
drawings is accomplished through the use of a commercial software
package known as Fast-RAD. In principle this may be done using a
combination of the open source software packages FreeCAD and
CADMesh to translate the CAD drawings into a GEANT4 readable format,
but such an avenue has not yet been fully explored. 

The CAD drawings contain the beam-line elements and the positions of
the detector survey points. These objects are described in the GDML
files using Tessellated solids to define the shapes of the physical
volumes. The detectors themselves are described using an independently
generated set of GDML files using GEANT4 standard volumes. An
additional XML file is appended to the geometry description that
assigns magnetic fields and associates the detectors to their
locations in the GDML files generated by Fast-RAD. This file is
initially written by the geometry maintainers and formatted to contain
run specific information during download.

The GDML format has a number of benefits. the files can be read via a
number of already existing libraries in GEANT4 and ROOT for the
purpose of independent verification and validation. For example the
GEANT4 example ``extended/persistancy/gdml/G01'' was used extensively
for validating the GDML files produced by Fast-RAD. Because it is a
subset of XML, the data contained in the GDML files are readily
accessible through the application of the ``libxml2'' python
extension. The GDML are in turn translated into the MAUS readable
geometry files either by directly accessing the data using the python
extension (which is the method applied to the detector objects) or
through the use of EXtensible Stylesheet Language Transformations
(XSLT) which applies a set of predefined transformations to the XML
files.

The following section shall describe how to use the available
executable to access and use these models.

\section{Geometry Download}

There are three executable files available to users which reside in
the directory /bin/utilities found within your copy of MAUS. The three
files of interest are upload\_geometry.py, download\_fit\_geometry.py
and get\_geometry\_ids.py. These files do the following.

\begin{description}
  \item[Upload Geometry] \hfill 
  \begin{enumerate}
   \item Set up the Configreader class and read the values provided by
   ConfigurationDefaults.py or by custom configure files.
   \item Instantiate an Uploader class object using the upload
   directory and geometry note taken from the configuration file.
   \item The list of files which is created by the Uploader class is
   used to compress the geometry files into one zip file.
   \item This zip file is then used as the argument for the
upload\_to\_CDB method which takes the contents of the zip and then
uploads this, as a single string to the CDB.
   \item[Optional] If cleanup is specified in the configuration file
then the file list and the original GDML files are the deleted leaving
only the zip file.
  \end{enumerate}

  \item[Download Geometry] \hfill
  \begin{enumerate}
   \item Set up the Configreader() class and read the values provided
   by ConfigurationDefaults.py or by custom configuration files.
   \item Instantiate a Downloader class object and downloads either
the current, time specified or run number zipped geometry to a
temporary cache location.
   \item The zip file is then unzipped in this location.
   \item The Location Fit is called which extracts the expected
   positions of the detector elements, the measured position of the
   survey points, and the anticipated positions of the survey points
   with respect to the detector center from the GDML files. The fit
   completes a fit with a chi-square statistic to match the position
   of the survey nest in the detector coordinate system to its
   position in the hall coordinate system using a change in the
   position and the rotation of the detector. The result is written to
   the GDML file. If the detector description is present in the
   download from CDB, that detector file name is also written to the
   main GDML file in place of the place-holder element.
   \item The Formatter class is called which formats the GDML
files. The formatting alters the schema location of these files and
points them to the correct local locations of the Materials GDML
file. This formatting leaves the original GDMLs in the temporary cache
and places the new formatted files in the download directory specified
by the configuration file.
   \item GDMLtoMAUS is then called with the location of the new
formatted files as its argument. This class converts the CAD GDMLs to
the MICE Module text files using the XSLT stylesheets previously
described and the Detector GDMLs to MICE modules using a python driven
routine.
   \item[Optional] If specified in the configuration file the
   temporary cache location is removed along with the zip file and
   unzipped files.
  \end{enumerate}

  \item[Get Geometry IDs]
  \begin{enumerate}
   \item Set up the Configreader() class and read the values provided
by ConfigurationDefaults.py or by custom configuration files. This
file takes start and stop time arguments to specify a period to search
the CDB.
   \item A CDB class object is then instantiated with the server
   specified in the configuration file.
   \item The get ids method from the CDB class is called and the
python dict which is downloaded is formatted and either printed to
screen or to file as specified in the configuration file.
  \end{enumerate}
\end{description}

Two other python files are also present in the utilities directory;
process\_geometry.py which fits, formats, and processes the GDML files
assuming the download is complete, and download\_geometry.py which
downloads, formats, and processes the GDML files without applying the
location fit--- legacy MICE module files will be used in the
simulation rather than the downloaded detector geometry files because
the Location fit makes this replacement. To use these files the user
must use the arguments in the ``ConfigurationDefaults.py'' file. The
arguments relating to these executables are as follows.

\begin{table*}
\begin{center}
\caption{Geometry control parameters.}
\begin{tabularx}{\textwidth}{lX}
\hline
\multicolumn{2}{l}{\emph{Geometry controls.}} \\
\hline
\verb|cdb_upload_url| & Sets the upload url relating the the Configuration Database.\\
\verb|cdb_download_url| & Sets the download url relating the the Configuration Database.\\
\verb|geometry_download_wsdl| & Name of the web service used for downloads.\\
\verb|geometry_download_directory| & Set the directory where you wish the geometry to be downloaded to.\\
\verb|geometry_download_by| & This can be set to either \textit{current, id or run\_number}. Current will download the current valid geometry stored
on the CDB. ID will download the geometry for the ID specified N.B ID numbers can be found using the get geometry ids executable. Run\_number will
download the geometry along with control room information for specified run including the beam-line currents. \\ 
\verb|geometry_download_run_number| & Set the number of the run to be downloaded.\\
\verb|geometry_download_id| & Set the number of the geometry ID to be downloaded.\\
\verb|geometry_download_cleanup| & Set to True in order to cleanup the temporary files created during the download process. These are the zip file
downloaded and the original GDML files from this zip file.\\
\verb|g4_step_max| & Set the G4 step max number which will be set in the ParentGeometryFile. This relates to the size of steps carried out during
the simulation.\\
\verb|geometry_upload_wsdl| & Name of the web service used for uploads. For developers use only.\\
\verb|geometry_upload_directory| & Set the the directory which stores the Fast-RAD produced GDML files which will be stored on the CDB. For Developers
use only.\\
\verb|geometry_upload_note| & Write the description of the geometry which is going to be uploaded. This should describe what is in the beam line
specifically what is new to the model. It should also include any other information the developer wishes the user to know. For developers use only.\\
\verb|geometry_upload_valid_from| & Set the date-time format of the date when this geometry about to be uploaded is valid from. For developers use
only.\\
\verb|geometry_upload_cleanup| & Set to True in order to cleanup the temporary files created during the upload process. These are the file
containing the list of GDMLs to be uploaded and also the original GDML files. For developers use only.\\
\verb|get_ids_start_time| & Set the start time of the period which you would like to get the ids from the configuration database. Must be in
date-time format.\\
\verb|get_ids_stop_time| & Set the stop time of the period which you would like to get the ids from the configuration database. Must be in
date-time format.\\
\verb|get_ids_create_file| & Set to True in order to create a file which lists the geometries available within the time period specified. If set to
False the geometry information will be printed to screen.\\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\section{Using the Geometry Download Executables}

The three executables described above will allow the user to
accomplish three different tasks; adding a new geometry to the
database, checking what geometries are available, and downloading the
desired geometry. The majority of users will not need to upload a new
geometry. At present this can only be done from the MLCR. The second
two operations are of primary interest for the everyday user. A list
of the CAD based geometries appears at
\url{http://cdb.mice.rl.ac.uk/cdbviewer/}, and selecting the geometry
tab. The user should be advised, however, that this list does not
contain all of the information necessary to run the geometry download
procedure. The best procedure is to use the get\_geometry\_ids.py
executable described above. For example to get all available entries
in the geometry database a user should run the command (from the maus
root directory)
\begin{verbatim}
> python /bin/utilities/get_geometry_ids.py 
      --get_ids_start_time ``1974-01-01 00:00:00'' --get_ids_stop_time ``2015-01-01 00:00:00''
\end{verbatim}
By default, the output file is saved to
\$MAUS\_ROOT\_DIR/tmp/geometry\_ids.txt. The typical output looks like
the following:
\begin{verbatim}
[...]

Geometry Number = 22
Geometry Note = Step IV geometry consisting of the detectors only for
debugging purposes. Includes the TOFs, Ckov, EMR, Tracker, and KL as
GDML files. EMR gdml file present, but not in use. Beamline elements
not included, but fields are present for quads, dipole, and
solenoid. Ckov files recreate MICE modules to generate incorrect
conical mirror object. A 180 degree rotation is applied to Tracker0
with respect to Tracker1. Survey information not included. Default
tracker Solenoid magnetic fields implemented with scaling to match
legacy files.
ValidFrom       = 1974-02-04 19:00:00
Date Created    = 2014-04-30 14:23:18.880000

Geometry Number = 23
Geometry Note = Step IV geometry with detectors including the TOFs,
Ckov, EMR, Tracker, and KL included as GDML files. EMR gdml file
present, but not in use. Downstream solenoid bore gdml file has been
edited to remove an appearent piece of material blocking the
beam. Ckov files recreate MICE modules to generate incorrect conical
mirror object. A 180 degree rotation is applied to Tracker0 with
respect to Tracker1. Survey information not included. Default tracker
Solenoid magnetic fields implemented with scaling as in legacy
files. Removed redundant objects from geometry description.
ValidFrom       = 1974-02-04 18:00:00
Date Created    = 2014-04-30 14:44:10.774000


Geometry Number = 24
Geometry Note = Step I geometry with detectors including the TOFs,
Ckov, EMR, Tracker, and KL included as GDML files. EMR gdml file
present, but not in use. Ckov files recreate MICE modules to generate
incorrect conical mirror object. Survey information included.
ValidFrom       = 1974-02-03 18:00:00
Date Created    = 2014-04-30 16:05:43.553000

\end{verbatim}
Three different flavors of geometry are represented here. The first
example is a geometry with no beamline elements included but with all
Step IV detectors and fields in place. This type of geometry has been
made available to test changes in the software while avoiding the
processing time necessary to load the tessellated solids used to
describe the beamline. The second is an idealized version of the Step
IV geometry based entirely on the CAD geometry. The idealized
geometries are labeled with a year of 197n for the ``Date Valid
From'' where n is the step number. The third example is a real version
of the Step I geometry with the survey information included for all
detectors.

The CAD-based geometry can be downloaded via a number of different
modes. The simplest way is to download the geometry by its id
number. From the MAUS root directory the debug geometry as described
above can be downloaded with the command
\begin{verbatim}
> python bin/utilities/download_fit_geometry.py --geometry_download_id 22
\end{verbatim}
By default the GDML files will be removed with this command. If the
user wishes to download the full geometry without removing the GDML
files because that user wants to run a systematic study requiring
reprocessing the geometry then the following command should be used:
\begin{verbatim}
> python bin/utilities/download_fit_geometry.py --geometry_download_id 24 --geometry_download_clenaup False
\end{verbatim}

A common usage for the geometry download is to reproduce a given
run. To simulate a representative run from the 2013 EMR run the
following command should be used:
\begin{verbatim}
> python bin/utilities/download_fit_geometry.py --geometry_download_by run_number --geometry_download_run 5519
\end{verbatim}
This function reads the beamline currents from the configuration
database and adjusts the fields of the beamline magnets appropriately.

A final application is to download the latest uploaded geometry. This
function can be completed using the following command:
\begin{verbatim}
> python bin/utilities/download_fit_geometry.py --geometry_download_by current
\end{verbatim}
All of these commands described will by default place the geometry in
the directory \${MAUS\_ROOT\_DIR}/files/geometry/download. This
directory may be changed using the
\verb+--geometry_download_directory+ flag. To use the downloaded
geometry in the simulation, the \verb+--simulation_geometry_filename+
flag must be set to the download directory. 
