\chapter{Geometry}
\label{chapter:geometry}
MAUS uses the on-line Configuration Database to store all of its
geometries. These geometries have been transferred from CAD drawings
which are based on the latest surveys and technical drawings
available. The CAD drawings are translated to a geometry specific
subset of XML, the Geometry Description Markup Language (GDML) prior
to being recorded in the configuration database. Translation of the CAD
drawings was accomplished through the use of a commercial software
package known as Fast-RAD. This can be done using a
combination of the open source software packages FreeCAD and
CADMesh to translate the CAD drawings into a GEANT4 readable format;
generation of an open source solution for MAUS is in progress.

The CAD drawings contain the beam-line elements and the positions of
the detector survey points. These objects are described in the GDML
files using Tessellated solids to define the shapes of the physical
volumes. The detectors themselves are described using an independently
generated set of GDML files using GEANT4 standard volumes. An
additional XML file is appended to the geometry description that
assigns magnetic fields and associates the detectors to their
locations in the GDML files generated by Fast-RAD. This file is
initially written by the geometry maintainers and formatted to contain
run specific information during download.

The GDML format has a number of benefits. the files can be read via a
number of already existing libraries in GEANT4 and ROOT for the
purpose of independent verification and validation. For example the
GEANT4 example ``extended/persistancy/gdml/G01'' was used extensively
for validating the GDML files produced by Fast-RAD. Because it is a
subset of XML, the data contained in the GDML files are readily
accessible through the application of the ``libxml2'' python
extension. The GDML are in turn translated into the MAUS readable
geometry files either by directly accessing the data using the python
extension (which is the method applied to the detector objects) or
through the use of EXtensible Stylesheet Language Transformations
(XSLT) which applies a set of predefined transformations to the XML
files.

The following section shall describe how to use the available
executable to access and use these models.

\section{Geometry Access Scripts}

There are three executable files available to users which reside in
the directory /bin/utilities found within your copy of MAUS. The three
files of interest are upload\_geometry.py, download\_geometry.py
and get\_geometry\_ids.py. These files do the following.

\begin{description}
  \item[Upload Geometry] \hfill 
  \begin{enumerate}
   \item Set up the Configreader class and read the values provided by
   ConfigurationDefaults.py or by custom configure files.
   \item Instantiate an Uploader class object using the upload
   directory and geometry note taken from the configuration file.
   \item The list of files which is created by the Uploader class is
   used to compress the geometry files into one zip file.
   \item This zip file is then used as the argument for the
upload\_to\_CDB method which takes the contents of the zip and then
uploads this, as a single string to the CDB.
   \item[Optional] If cleanup is specified in the configuration file
then the file list and the original GDML files are the deleted leaving
only the zip file.
  \end{enumerate}

  \item[Download Geometry] \hfill
  \begin{enumerate}
   \item Set up the Configreader() class and read the values provided
   by ConfigurationDefaults.py or by custom configuration files.
   \item Instantiate a Downloader class object and downloads either
the current, time specified or run number zipped geometry to a
temporary cache location.
   \item The zip file is then unzipped in this location.
   \item The Formatter class is called which formats the GDML
files. The formatting alters the schema location of these files and
points them to the correct local locations of the Materials GDML
file. This formatting leaves the original GDMLs in the temporary cache
and places the new formatted files in the download directory specified
by the configuration file.
   \item GDMLtoMAUS is then called with the location of the new
formatted files as its argument. This class converts the CAD GDMLs to
the MICE Module text files using the XSLT stylesheets previously
described and the Detector GDMLs to MICE modules using a python driven
routine. Note that this step is used even when the geometry is
designed for use with the GDMLParser.
   \item[Optional] If specified in the configuration file the
   temporary cache location is removed along with the zip file and
   unzipped files.
  \end{enumerate}

  \item[Get Geometry IDs]
  \begin{enumerate}
   \item Set up the Configreader() class and read the values provided
by ConfigurationDefaults.py or by custom configuration files. This
file takes start and stop time arguments to specify a period to search
the CDB.
   \item A CDB class object is then instantiated with the server
   specified in the configuration file.
   \item The get ids method from the CDB class is called and the
python dict which is downloaded is formatted and either printed to
screen or to file as specified in the configuration file.
  \end{enumerate}
\end{description}

Two other python files are also present in the utilities directory;
process\_geometry.py which fits, formats, and processes the GDML files
assuming the download is complete, and download\_fit\_geometry.py
which downloads, formats, and processes the GDML files while applying
the location fit--- the GDML files generated for Step IV running will
have the fit applied prior to upload. To use these files the user must
use the arguments in the ``ConfigurationDefaults.py'' file. The
arguments relating to these executables are as follows.

\begin{table*}
\begin{center}
\caption{Geometry control parameters.}
\begin{tabularx}{\textwidth}{lX}
\hline
\multicolumn{2}{l}{\emph{Geometry controls.}} \\
\hline
\verb|cdb_upload_url| & Sets the upload url relating to the Configuration Database.\\
\verb|cdb_download_url| & Sets the download url relating to the Configuration Database.\\
\verb|cdb_cc_download_url| & Sets the download url relating to the Configuration Database for the super-conducting channels only.\\
\verb|geometry_download_wsdl| & Name of the web service used for downloads.\\
\verb|geometry_download_directory| & Set the directory where you wish the geometry to be downloaded to.\\
\verb|geometry_download_by| & This can be set to either \textit{current, id or run\_number}. Current will download the current valid geometry stored
on the CDB. ID will download the geometry for the ID specified N.B ID numbers can be found using the get geometry ids executable. Run\_number will
download the geometry along with control room information for specified run including the beam-line currents. \\ 
\verb|geometry_download_run_number| & Set the number of the run to be downloaded.\\
\verb|geometry_download_beamline_for_run| & Set the beamline information to match a run independent of the geometry download. To be used when 
geometry is downloaded by ID.\\
\verb|geometry_download_coolingchannel_tag| & Download the cooling channel data matching a specific tag.\\
\verb|geometry_download_id| & Set the number of the geometry ID to be downloaded.\\
\verb|geometry_download_cleanup| & Set to True in order to cleanup the temporary files created during the download process. These are the zip file
downloaded and the original GDML files from this zip file.\\
\verb|g4_step_max| & Set the G4 step max number which will be set in the ParentGeometryFile. This relates to the size of steps carried out during
the simulation.\\
\verb|geometry_upload_wsdl| & Name of the web service used for uploads. For developers use only.\\
\verb|geometry_upload_directory| & Set the the directory which stores the Fast-RAD produced GDML files which will be stored on the CDB. For Developers
use only.\\
\verb|geometry_upload_note| & Write the description of the geometry which is going to be uploaded. This should describe what is in the beam line
specifically what is new to the model. It should also include any other information the developer wishes the user to know. For developers use only.\\
\verb|geometry_upload_valid_from| & Set the date-time format of the date when this geometry about to be uploaded is valid from. For developers use
only.\\
\verb|geometry_upload_cleanup| & Set to True in order to cleanup the temporary files created during the upload process. These are the file
containing the list of GDMLs to be uploaded and also the original GDML files. For developers use only.\\
\verb|get_ids_start_time| & Set the start time of the period which you would like to get the ids from the configuration database. Must be in
date-time format.\\
\verb|get_ids_stop_time| & Set the stop time of the period which you would like to get the ids from the configuration database. Must be in
date-time format.\\
\verb|get_ids_create_file| & Set to True in order to create a file which lists the geometries available within the time period specified. If set to
False the geometry information will be printed to screen.\\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\section{Using the Geometry Download Executables}

The three executables described above will allow the user to
accomplish three different tasks; adding a new geometry to the
database, checking what geometries are available, and downloading the
desired geometry. The majority of users will not need to upload a new
geometry. At present this can only be done from the MLCR. The second
two operations are of primary interest for the everyday user. A list
of the CAD based geometries appears at
\url{http://cdb.mice.rl.ac.uk/cdbviewer/}, and selecting the geometry
tab. The user should be advised, however, that this list does not
contain all of the information necessary to run the geometry download
procedure. The best procedure is to use the get\_geometry\_ids.py
executable described above. For example to get all available entries
in the geometry database a user should run the command (from the maus
root directory)
\begin{verbatim}
> python /bin/utilities/get_geometry_ids.py 
      --get_ids_start_time ``1999-01-01 00:00:00'' --get_ids_stop_time ``2035-01-01 00:00:00''
\end{verbatim}
By default, the output file is saved to
\$MAUS\_ROOT\_DIR/tmp/geometry\_ids.txt. The typical output looks like
the following:
\begin{verbatim}
[...]
Geometry Number = 46
Geometry Note   = Step I geometry consistent with the October 2011 data run. All detector descriptions consistent and up to date.
ValidFrom       = 2011-12-01 19:17:00
Date Created    = 2015-01-07 14:19:51.055000

Geometry Number = 47
Geometry Note   = Step I geometry consistent with the October 2013 EMR comissioning run. All detector descriptions consistent and up to date.
ValidFrom       = 2013-10-06 19:17:00
Date Created    = 2015-01-07 14:30:32.987000

Geometry Number = 49
Geometry Note   = Step IV geometry with detectors including the TOFs, Ckov, EMR, Tracker, and KL included as GDML files. Update to the EMR geometry.
ValidFrom       = 2034-01-03 19:17:00
Date Created    = 2015-03-23 17:24:23.079000

Geometry Number = 50
Geometry Note   = Step IV geometry with detectors including the TOFs, Ckov, EMR, Tracker, and KL included as GDML files. Written for GDMLParser. Diffuser corrected to match design specification.
ValidFrom       = 2034-05-13 19:17:00
Date Created    = 2015-05-14 16:29:01.124000
\end{verbatim}

Three different flavors of geometry are represented here. The first is
the geometry of the Step I geometry as it existed in the hall during
data collection in Autumn 2013 (id 47). This description includes the
survey information taken prior to data collection although the
positions of the detectors have not been adjusted to match that
information in the upload; a fit mut be done at download time. The
second is a prospective Step IV geometry based on the CAD geometry (id
49). This geometry was intended to be used after the MICE module
translation. In contrast the third type of geometry is meant to be
used with the GDMLParser (id 50). This geometry should load in a much
shorter time than the MICE module translation due to the optimized
treatment of the tesselated solid objects. Both of these last two
cases do not contain survey information and are therefore dated to be
valid from a date far in the future (2034).

The CAD-based geometry can be downloaded via a number of different
modes. The simplest way is to download the geometry by its id
number. From the MAUS root directory the debug geometry as described
above can be downloaded with the command
\begin{verbatim}
> python bin/utilities/download_geometry.py --geometry_download_id 50
\end{verbatim}
By default the unformatted GDML files will be removed with this
command. If the user wishes to download the full geometry without
removing the unformatted GDML files because that user wants to run a systematic
study requiring reprocessing the geometry then the following command
should be used:
\begin{verbatim}
> python bin/utilities/download_geometry.py --geometry_download_id 50 --geometry_download_cleanup False
\end{verbatim}
A more complicated use is to test a prospective geometry with a
predefined beamline setting as defined using a ``tagged'' beamline:
\begin{verbatim}
> python bin/utilities/download_geometry.py --geometry_download_id 50 --geometry_download_beamline_tag '6-200+M0'
\end{verbatim}

A common usage for the geometry download is to reproduce a given
run. To simulate a representative run from the 2013 EMR run the
following command should be used:
\begin{verbatim}
> python bin/utilities/download_fit_geometry.py --geometry_download_by run_number --geometry_download_run 5519
\end{verbatim}
This function reads the beamline currents from the configuration
database and adjusts the fields of the beamline magnets appropriately.

A final application is to download the latest uploaded geometry. This
function can be completed using the following command:
\begin{verbatim}
> python bin/utilities/download_fit_geometry.py --geometry_download_by current
\end{verbatim}
All of these commands described will by default place the geometry in
the directory \${MAUS\_ROOT\_DIR}/files/geometry/download. This
directory may be changed using the
\verb+--geometry_download_directory+ flag. To use the downloaded
geometry in the simulation, the \verb+--simulation_geometry_filename+
flag must be set to the download directory. 

\usepackage{listings}

\section{A Little GDML}
While the detectors are already defined and the beam line elements are
defined from the CAD information, it is potentially useful for users
and developers to understand these data structures. The overall
structure of a GDML file is always the same; the lithium hydride disk
absorber is described using the following lines
\lstinputlisting[breaklines]{Disk_LiH.gdml}

More fundamental definitions appear at the top while more derived
objects appear at the bottom culminating in the ``world'' definition
as the last object. Variables are defined in the ``define'' section,
material definitions appear in the ``materials'' section, solid
objects used in the definition of the structure appear in the
``solids'' section, and the volumes making up the simulated geometry
appear in the ``structure'' section.  A little more detail and MICE
specific examples are given below, but it is highly suggested that an
interested user refer to the ``GDML Users
Guide''\footnote{\url{http://gdml.web.cern.ch/GDML/doc/GDMLmanual.pdf}}.

\subsection{Define}
This is where constants, matrices, and variables are defined. The
obvious benefit is that any variables defined here may be referenced
multiple times throughout the GDML document. Trivial examples include
the definition of pi or the identity rotation. A slightly more
interesting example is the use of a matrix in \verb+EMR.gdml+ to
indicate whether a 90$^{\circ}$ rotation needs to be applied to a
scintillator bar or a plane at a given location.

\subsection{Materials}
All materials are defined internally to the GDML file. Each detector
has only the materials used in its construction defined in the source
file, while a stock summary of all materials used are written to the
files derived from the MICE engineering drawings. Materials are
composed of elements or mixtures of elements defined by the mass
fraction or the atom count.

\subsection{Solids}
The definition of solid objects parallels the definition of solids in
Geant. Primitive solids such as spheres, tubes, cones, and boxes, may
be explicitly defined. All of the detectors are defined entirely using
primitive volumes. More complicated, tessellated solids may also be
defined, with the vertices written to the ``define'' section of the
code. The MICE engineering drawings are defined entirely using
tessellated solids using the FastRAD package.

\subsection{Structure}
Definition of the geometry volume is contained in the structure
section of the file. Volumes are defined based on references to
predefined solids and materials. Daughter volumes to objects may be
defined through the use of \verb+physvol+ and
\verb+paramvol+. Relative positions and rotations of daughter objects
are defined as part of these definitions. Loops and ensembles may also
be used to define multiple copies of objects displaced in position or
rotations.

\subsection{Additional Features and Sensitive Detectors}
When defining a volume it is possible to define auxiliary
properties. These properties do not affect the structural behaviour of
the detector within the simulation but may be used to alter the
properties of the simulation. An example is the sensitive detector
definition. For every volume with a auxiliary property
\verb+SensitiveDetector+ a matching sensitive detector object is
constructed and linked to the source volume. The requirements of the
MICE sensitive detector objects to use detector identity information
explicitly written to the MICE module files have forced the GDML files
to avoid the use of loops for the definition of repeated objects
within the TOFs and the Trackers. No such requirement exists for the
definition of sensitive detectors in the EMR because the sensitive
detectors are defined using GEANT's native touchable volume
definitions.

\section{Creation of New Geometries in MAUS}

A python class, CADModuleExtraction, is available that automatically
generates a set of geometry files suitable for upload to CDB. It is
run during the course of the standard installation tests to provide a
native version of the Step IV geometry but this class should not be
run by the casual user. To use this class the user must provide a GDML
file containing references to all of the GDML files generated from the
CAD and the detector GDML files positioned in their approximate
locations (which should be furnished by a subset of the CAD drawings)
as well as the location of a MAUS information file, which need not be
in the same directory as the source GDML file. A destination directory
and file name must also be provided. The script then runs through the
referenced GDML files and copies the objects contained therein to a
new set of defined by location, instead of by material which is the
arrangement required by the CAD model. This processing is required to
make a single set of files that can be read into GEANT4
efficiently. The output of this script may be uploaded to CDB after
applying corrections to the detector locations based on the fits to
the survey information and passing the validation tests.
