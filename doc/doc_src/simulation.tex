\chapter{Running the Monte Carlo}
\label{chapter:simulation}
The simulation module provides particle generation routines, GEANT4 bindings to track particles through the geometry and routines to convert modelled energy loss in detectors into digitised signals from the MICE DAQ. The Digitisation models are documented under each detector. Here we describe the beam generation and GEANT4 interface.

\section{Beam Generation}
Beam generation is handled by the MapPyBeamMaker module. Beam generation is separated into two classes. The MapPyBeamGenerator has routines to assign particles to a number of individual beam classes, each of which samples particle data from a predefined parent distribution. Beam generation is handled by the \verb|beam| datacard.

The MapPyBeamMaker can either take particles from an external file, overwrite existing particles in the spill, add a specified number of particles from each beam definition, or sample particles from a binomial distribution. The random seed is controlled at the top level and different algorithms can be selected influencing how this is used to generate random seeds on each particle. 

Each beam definition has routines for sampling from a multivariate gaussian distribution or generating ensembles of identical particles (called "pencil" beams here). Additionally it is possible to produce time distributions that are either rectangular or triangular in time to give a simplistic representation of the MICE time distribution.

The beam definition controls are split into four parts. The \verb|reference| branch defines the centroid of the distribution; the \verb|transverse| branch defines the transverse coordinates, $x, y, px, py$; the \verb|longitudinal| branch defines the longitudinal coordinates - time and energy/momentum and the \verb|coupling| branch defines correlations between longitudinal and transverse. Additionally a couple of parameters are available to control random seed generation and relative weighting between different beam definitions.

In transverse, beams are typically sampled from a multivariate gaussian. The Twiss beam ellipse is defined by
\begin{equation}
\mathbf{B_\perp} = m \left(\begin{array}{cccc}
\epsilon_x \beta_x/p   & -\epsilon_x\alpha_x & 0 & 0 \\
-\epsilon_x\alpha_x & \epsilon_x\gamma_x p  & 0 & 0 \\
0 & 0  & \epsilon_y\beta_y/p  & -\epsilon_y\alpha_y \\
0 & 0 & -\epsilon_y\alpha_y & \epsilon_y\gamma_y p \\
\end{array}\right)
\end{equation}
The Penn beam ellipse is defined by,
\begin{equation}
\mathbf{B_\perp} = m\epsilon_\perp \left(\begin{array}{cccc}
\beta_\perp/p   & -\alpha_\perp & 0 & -\mathcal{L}+\beta_\perp B_0/2p \\
-\alpha_\perp & \gamma_\perp p  & \mathcal{L}-\beta_\perp B_0/2p & 0 \\
0 & \mathcal{L}-\beta_\perp B_0/2p  & \beta_\perp/p  & -\alpha_\perp \\
-\mathcal{L}+\beta_\perp B_0/2p & 0 & -\alpha_\perp & \gamma_\perp p \\
\end{array}\right)
\end{equation}
where parameters can be controlled in datacards as described below. Note that using the datacards it is possible to define a beam ellipse that is poorly conditioned (determinant nearly zero). In this case MAUS will print an error message like \verb|Warning: invalid value encountered in double_scalars| for each primary.

\subsection{Beam Polarisation}
It is also possible to pass a polarised beam through MAUS. A polarised beam can be generated using the \verb|beam_polarisation| variable on an individual beam parameter. Currently only one polarisation model has been implemented, \verb|gaussian_unit_vectors|. This throws a Gaussian in each of the x, y and z directions and uses this to generate a spin vector. The spin vector is then normalised to 1. Correlations are not implemented.


\begin{table*}
\begin{center}
\caption{Control parameters pertaining to all beam definitions.}
\begin{tabularx}{\textwidth}{lX}
Name & Meaning \\
\hline
\verb|beam| & dict containing beam definition parameters.\\
\hline
\multicolumn{2}{l}{\emph{The following cards should all be defined within the \verb|beam| dict.}} \\
\hline
\verb|particle_generator| & Set to \verb|binomial| to choose the number of particles by sampling from a binomial distribution. Set to \verb|counter| to choose the number of particles in each beam definition explicitly. Set to \verb|file| to generate particles by reading an input file. Set to \verb|overwrite_existing| to generate particles by overwriting existing primaries. \\
\verb|binomial_n| & When using a binomial \verb|particle_generator|, this controls the number of trials to make. Otherwise ignored. \\
\verb|binomial_p| & When using a binomial \verb|particle_generator|, this controls the probability a trial yields a particle. Otherwise ignored. \\
\verb|beam_file_format| & When using a file \verb|particle_generator|, set the input file format - options are 
                          \begin{itemize}
                            \setlength{\itemsep}{0mm}
                            \item \verb|icool_for009|
                            \item \verb|icool_for003|,
                            \item \verb|g4beamline_bl_track_file|
                            \item \verb|g4mice_special_hit|
                            \item \verb|g4mice_virtual_hit|
                            \item  \verb|mars_1|
                            \item \verb|maus_virtual_hit|
                            \item \verb|maus_primary|
                          \end{itemize}\\
\verb|beam_file|&  When using a file \verb|particle_generator|, set the input file name. Environment variables are automatically expanded by MAUS.\\
\verb|file_particles_per_spill| & When using a file \verb|particle_generator|, this controls the number of particles per spill that will be read from the file.\\
\verb|random_seed| & Set the random seed, which is used to generate individual random seeds for each primary (see below). \\
\verb|definitions| & A list of dicts, each item of which is a dict defining the distribution from which to sample individual particles. \\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}


\begin{table*}
\begin{center}
\caption{Individual beam distribution parameters.}
\begin{tabularx}{\linewidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{l}{\emph{The following cards should be inside a dict in the beam \verb|definitions| list.}} \\
\hline
\verb|random_seed_algorithm| & Choose from the following options
                          \begin{itemize}
                            \setlength{\itemsep}{0mm}
                            \item \verb|beam_seed|: use the \verb|random_seed| for all particles
                            \item \verb|random|: use a different randomly determined seed for each particle
                            \item \verb|incrementing|: use the \verb|random_seed| but increment by one each time a new particle is generated
                            \item \verb|incrementing_random|: determine a seed at random before any particles are generated; increment this by one each time a new particle is generated
                          \end{itemize}\\
\verb|weight| & When \verb|particle_generator| is \verb|binomial| or \verb|overwrite_existing|, the probability that a particle will be sampled from this distribution is given by $weight/(sumofweights)$.\\
\verb|n_particles_per_spill| & When \verb|particle_generator| is \verb|counter|, this sets the number of particles that will be generated in each spill. \\
\verb|reference| & Dict containing the reference particle definition. \\
\verb|transverse| & Dict defining the longitudinal phase space distribution. \\
\verb|longitudinal| & Dict defining the longitudinal phase space distribution. \\
\verb|coupling| & Dict defining any correlations between transverse and longitudinal. \\
\verb|beam_polarisation| & Dict defining the polarisation of the beam. If this dict is not included, the beam is taken to be unpolarised. \\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Beam distribution reference definition.}
\begin{tabularx}{\linewidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{|l|}{\emph{The following cards should be defined in each beam definition \verb|reference| dict.}} \\
\hline
\verb|position| & dict with elements \verb|x|, \verb|y| and \verb|z| that define the reference position (mm).\\
\verb|momentum| & dict with elements \verb|x|, \verb|y| and \verb|z| that define the reference momentum direction. Normalised to 1 at runtime.\\
\verb|particle_id| & PDG particle ID of the reference particle.\\
\verb|energy| & Reference energy. \\
\verb|time| & Reference time (ns). \\
\verb|random_seed| & Set to 0 - this parameter is ignored.\\
\begin{makeimage} 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Beam definition transverse parameters.}
\begin{tabularx}{\linewidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{|l|}{\emph{The following cards should be defined in each beam definition \verb|transverse| dict.}} \\
\hline
\verb|transverse_mode| & Options are
                          \begin{itemize}
                            \setlength{\itemsep}{0mm}
                            \item \verb|pencil|: x, py, y, py taken from \verb|reference|
                            \item \verb|penn|: cylindrical beam symmetric in x and y
                            \item \verb|constant_solenoid|: cylindrical beam symmetric in x and y, with beam radius calculated from on-axis B-field to give constant beam radius along a solenoid.
                            \item \verb|twiss|: beam with decoupled x and y beam ellipses.
                          \end{itemize} \\
\hline
\begin{tabular}{l}\verb|normalised_angular_| \\ \verb|momentum| \end{tabular} & if \verb|transverse_mode| is \verb|penn| or \verb|constant_solenoid|, set $\mathcal{L}$.\\
\verb|emittance_4d| & if \verb|transverse_mode| is \verb|penn| or \verb|constant_solenoid|, set $\epsilon_\perp$.\\
\verb|beta_4d| & if \verb|transverse_mode| is \verb|penn|, set $\beta_\perp$.\\
\verb|alpha_4d| & if \verb|transverse_mode| is \verb|penn|, set $\alpha_\perp$.\\
\verb|bz| & if \verb|transverse_mode| is \verb|constant_solenoid|, set the B-field used to calculate $\beta_\perp$ and $\alpha_\perp$.\\
\hline
\verb|beta_x| & if \verb|transverse_mode| is \verb|twiss|, set $\beta_x$.\\
\verb|alpha_x| & if \verb|transverse_mode| is \verb|twiss|, set $\alpha_x$.\\
\verb|emittance_x| & if \verb|transverse_mode| is \verb|twiss|, set $\epsilon_x$.\\
\verb|beta_y| & if \verb|transverse_mode| is \verb|twiss|, set $\beta_y$.\\
\verb|alpha_y| & if \verb|transverse_mode| is \verb|twiss|, set $\alpha_y$.\\
\verb|emittance_y| & if \verb|transverse_mode| is \verb|twiss|, set $\epsilon_y$.\\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Beam definition longitudinal parameters.}
\begin{tabularx}{\linewidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{l}{\emph{The following cards should be defined in each beam definition \verb|longitudinal| dict.}} \\
\hline
\verb|momentum_variable| & In all modes, set this variable to control which longitudinal variable will be used to control the input beam. Options are \verb|energy|, \verb|p|, \verb|pz|. \\
\verb|longitudinal_mode| & Options are
                          \begin{itemize}
                            \setlength{\itemsep}{0mm}
                            \item \verb|pencil|: time, energy/p/pz taken from \verb|reference|
                            \item \verb|gaussian|: uncorrelated gaussians in time and energy/p/pz
                            \item \verb|twiss|: multivariate gaussian in time and energy/p/pz
                            \item \verb|uniform_time|: gaussian in energy/p/pz and uniform in time.
                            \item \verb|sawtooth_time|: gaussian in energy/p/pz and sawtooth in time.
                          \end{itemize} \\
\hline
\verb|beta_l| & In Twiss mode, set $\beta_l$\\
\verb|alpha_l| & In Twiss mode, set $\alpha_l$\\
\verb|emittance_l| & In Twiss mode, set $\epsilon_l$\\
\hline
\verb|sigma_t| & In \verb|gaussian| mode, set the RMS time. \\
\begin{tabular}{l} \verb|sigma_p| \\ \verb|sigma_energy| \\ \verb|sigma_pz| \end{tabular} & In \verb|gaussian|, \verb|uniform_time|, \verb|sawtooth_time| mode, set the RMS energy/p/pz. \\
\hline
\verb|t_start| & In \verb|uniform_time| and \verb|sawtooth_time| mode, set the start time of the parent distribution \\
\verb|t_end| & In \verb|uniform_time| and \verb|sawtooth_time| mode, set the end time of the parent distribution \\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Beam definition coupling parameters.}
\begin{tabularx}{\linewidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{l}{\emph{The following cards should be defined in each beam definition \verb|coupling| dict.}} \\
\hline
\verb|coupling_mode| & Set to \verb|none| - not implemented yet. \\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Beam definition polarisation.}
\begin{tabularx}{\linewidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{l}{\emph{The following cards should be defined in each beam definition \verb|beam_polarisation| dict.}} \\
\hline
\verb|polarisation_mode| & If set to \verb|flat|, the beam is taken as unpolarised. If set to \verb|gaussian_unit_vectors|, spin vector is given by a gaussian distribution in x, y, z; the spin vector is then normalised to 1 before tracking. \\
\verb|beam_mean_x| & If \verb|beam_polarisation| is set to \verb|gaussian_unit_vectors|, the mean x value of the gaussian. \\
\verb|beam_sigma_x| & If \verb|beam_polarisation| is set to \verb|gaussian_unit_vectors|, the sigma x value of the gaussian. \\
\verb|beam_mean_y| & If \verb|beam_polarisation| is set to \verb|gaussian_unit_vectors|, the mean y value of the gaussian. \\
\verb|beam_sigma_y| & If \verb|beam_polarisation| is set to \verb|gaussian_unit_vectors|, the sigma y value of the gaussian. \\
\verb|beam_mean_z| & If \verb|beam_polarisation| is set to \verb|gaussian_unit_vectors|, the mean z value of the gaussian. \\
\verb|beam_sigma_z| & If \verb|beam_polarisation| is set to \verb|gaussian_unit_vectors|, the sigma z value of the gaussian. \\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage}
\end{tabularx}
\end{center}
\end{table*}

\section{GEANT4 Bindings}
The GEANT4 bindings are encoded in the Simulation module. GEANT4 groups particles by run, event and track. A GEANT4 run maps to a MICE spill; a GEANT4 event maps to a single inbound particle from the beamline; and a GEANT4 track corresponds to a single particle in the experiment.

A number of classes are provided for basic initialisation of GEANT4.

\begin{itemize}
\item MAUSGeant4Manager: is responsible for handling interface to GEANT4. MAUSGeant4Manager handles initialisation of the GEANT4 bindings as well as accessors for individual GEANT4 objects (see below). Interfaces are provided to run one or many particles through the geometry, returning the relevant event data. The MAUSGeant4Manager sets and clears the event action before each run.
\item MAUSPhysicsList: contains routines to set up the GEANT4 physical processes. Datacards settings are provided to disable stochastic processes or all processes and set a few parameters. In the end, the physics list set up gets called by the FieldPhaser.
\item FieldPhaser: the field phaser is a MAUS-specific tool for automatically phasing fields, for example RF cavities, such that they ramp coincidentally with incoming particles. The FieldPhaser contains routines to fire test ("reference") particles through the accelerator lattice and phase fields appropriately. The FieldPhaser phasing routines are called after GEANT4 is first initialised.
\item DetectorConstruction: the DetectorConstruction routines provide an interface between the MAUS internal geometry representation encoded in MiceModules and GEANT4. DetectorConstruction is responsible for calling the relevant routines for setting up the general engineering geometry, calling detector-specific geometry set-up routines and calling the field map set-up routines.
\item VirtualPlanes: the VirtualPlanes routines are designed to extract particle data from the GEANT4 tracking independently of the GEANT4 geometry. The VirtualPlanes routines watches for steps that step across some plane in physical space, or some time, or some proper time, and then interpolates from the step ends to the plane in question.
\item FillMaterials: (legacy) the FillMaterials routines are used to initialise a number of specific 
\item MAUSVisManager the MAUSVisManager is responsible for handling interfaces with the GEANT4 visualisation.
\end{itemize}

The GEANT4 \emph{Action} objects provide interfaces for MAUS-specific function calls at certain points in the tracking.

\begin{itemize}
\item MAUSRunAction: sets up the running for a particular spill. In MAUS, it just reinitialises the visualisation.
\item MAUSEventAction: sets up the running for a particular inbound particle. At the beginning of each event, the virtual planes, tracking, detectors and stepping are all cleared. After the event the event data is pulled into the event data from each element.
\item MAUSTrackingAction: is called when a new track is created or destroyed. If \verb|keep_tracks| datacard is set to True, on particle creation, MAUSTrackingAction writes the initial and final track position and momentum to the output data tree. If \verb|keep_steps| is set to True MAUSTrackingAction gets step data from MAUSSteppingAction and writes this also.
\item MAUSSteppingAction: is called at each step of the particle. If \verb|keep_steps| datacard is set to True, output step data is recorded. MAUSSteppingAction kills particles if they exceed the \verb|maximum_number_of_steps| datacard. MAUSSteppingAction calls the VirtualPlanes routines on each step.
\item MAUSStackingAction: is called when a new track is created, prioritising particle tracking. Handles killing particles based on the \verb|kinetic_energy_threshold|, \verb|default_keep_or_kill| and \verb|keep_or_kill_particles| datacards.
\item MAUSPrimaryGeneratorAction: is called at the start of every event and sets the particle data for each event. In MAUS, this particle generation is handled externally and so the MAUSPrimaryGeneratorAction role is to look for the primary object on the Monte Carlo event and convert this into a GEANT4 event object.
\end{itemize}

\begin{table*}
\begin{center}
\caption{Monte Carlo control parameters.}
\begin{tabularx}{\textwidth}{lX}
Name & Meaning \\
\hline
\multicolumn{2}{l}{\emph{General Monte Carlo controls.}} \\
\hline
\verb|simulation_geometry_filename| & Filename for the simulation geometry - searches first in files tagged by environment variable \verb|${MICEFILES}|, then in the local directory.\\
\verb|simulation_reference_particle| & Reference particle used for phasing fields.\\
\verb|keep_tracks| & Set to boolean true to store the initial and final position/momentum of each track generated by MAUS.\\
\verb|keep_steps| & Set to boolean true to store every step generated by MAUS - warning this can lead to large output files.\\
\verb|maximum_number_of_steps| & Set to an integer value. Tracks taking more steps are assumed to be looping.\\
\verb|check_volume_overlaps| & Set to a boolean value. Check for overlaps in volumes. If an overlap is detected, Geant4 will report a warning and then quit.\\
\verb|spin_tracking| & Set to boolean true to precess muon spin vectors through electromagnetic fields.\\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Physics list control parameters.}
\begin{tabularx}{\textwidth}{lX}
\hline
\multicolumn{2}{l}{\emph{Physics list controls.}} \\
\hline
\verb|physics_model| & GEANT4 physics model used to set up the physics list.\\
\verb|physics_processes| & Choose which physics processes normal particles observe during tracking. Options are 
                            \begin{itemize}
                            \item \verb|normal| particles will obey normal physics processes, scattering and energy straggling will be active.
                            \item \verb|mean_energy_loss| particles will lose a deterministic amount of energy during interaction with materials and will never decay.
                            \item \verb|none| Particles will never lose energy or scatter during tracking and will never decay.
                            \end{itemize} \\
\verb|reference_physics_processes| & Choose which physics processes the reference particle observes during tracking. Options are \verb|mean_energy_loss| and \verb|none|. The reference particle can never have stochastic processes enabled.\\
\verb|particle_decay| & Set to boolean true to enable particle decay; set to boolean false to disable.\\
\verb|polarised_decay| & Set to boolean true to make muons decay according to standard physics for a polarised muon; set to boolean false to make muons decay as if unpolarised. If polarised decay is true, then spin tracking is automatically enabled, regardless of the value of the \verb|spin_tracking| datacard.\\
\verb|charged_pion_half_life| & Set the half life for charged pions.\\
\verb|muon_half_life| & Set the half life for muons.\\
\verb|production_threshold| & Set the geant4 production threshold.\\
\verb|kinetic_energy_threshold| & Threshold for kinetic energy of new particles at production. Particles with kinetic energy below this value will not be tracked.\\
\verb|default_keep_or_kill| & If set to \verb|true|, keep particles with type not listed in \verb|keep_or_kill_particles|. If set to \verb|false|, kill particles with type not listed in \verb|keep_or_kill_particles|\\
\verb|keep_or_kill_particles| & Maps string particle type name to boolean flag. If set to true, always keep particles of this type. If set to false, always kill particles of this type. If not set, apply \verb|default_keep_or_kill|\\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Visualisation control parameters.}
\begin{tabularx}{\textwidth}{lX}
\hline
\multicolumn{2}{l}{\emph{Visualisation controls.}} \\
\hline
\verb|geant4_visualisation| & Set to boolean true to activate GEANT4 visualisation.\\
\verb|visualisation_viewer| & Control which viewer to use to visualise GEANT4 tracks. Currently only vrmlviewer is compiled into GEANT4 by default. Users can recompile GEANT4 with additional viewers enabled at their own risk.\\
\verb|visualisation_theta| & Set the theta angle of the camera.\\
\verb|visualisation_phi| & Set the phi angle of the camera.\\
\verb|visualisation_zoom| & Set the camera zoom.\\
\verb|accumulate_tracks| & Set to 1 to accumulate all of the simulated tracks into one vrml file. 0 for multiple files.\\
\verb|default_vis_colour| & Set the RGB values to alter the default colour of particles.\\
\verb|pi_plus_vis_colour| & Set the RGB values to alter the colour of positive pions.\\
\verb|pi_minus_vis_colour| & Set the RGB values to alter the colour of negative pions.\\
\verb|mu_plus_vis_colour| & Set the RGB values to alter the colour of positive muons.\\
\verb|mu_minus_vis_colour| & Set the RGB values to alter the colour of negative muons.\\
\verb|e_plus_vis_colour| & Set the RGB values to alter the colour of positrons.\\
\verb|e_minus_vis_colour| & Set the RGB values to alter the colour of electrons.\\
\verb|gamma_vis_colour| & Set the RGB values to alter the colour of gammas.\\
\verb|neutron_vis_colour| & Set the RGB values to alter the colour of neutrons.\\
\verb|photon_vis_colour| & Set the RGB values to alter the colour of photons.\\
\begin{makeimage} % force latex2html to render as an html table 
\end{makeimage} 
\end{tabularx}
\end{center}
\end{table*}


